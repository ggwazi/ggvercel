name: Code Review

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install --ignore-workspace

      - name: Type check
        id: typecheck
        run: |
          npx tsc --noEmit 2>&1 | tee typecheck-output.txt || true
          echo "errors=$(grep -c 'error TS' typecheck-output.txt || echo 0)" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Analyze changes
        id: analysis
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            let summary = '## ðŸ¤– Automated Code Review\n\n';

            // Change statistics
            const stats = { added: 0, removed: 0, modified: 0 };
            const categories = { src: [], tests: [], config: [], docs: [], ci: [] };

            for (const file of files) {
              stats.added += file.additions;
              stats.removed += file.deletions;
              stats.modified += file.changes;

              if (file.filename.startsWith('src/')) categories.src.push(file.filename);
              else if (file.filename.includes('.test.') || file.filename.includes('.spec.')) categories.tests.push(file.filename);
              else if (file.filename.includes('.yml') || file.filename.includes('.json')) categories.config.push(file.filename);
              else if (file.filename.endsWith('.md')) categories.docs.push(file.filename);
              else if (file.filename.startsWith('.github/')) categories.ci.push(file.filename);
            }

            summary += `### ðŸ“Š Change Summary\n`;
            summary += `| Metric | Count |\n|--------|-------|\n`;
            summary += `| Files changed | ${files.length} |\n`;
            summary += `| Lines added | +${stats.added} |\n`;
            summary += `| Lines removed | -${stats.removed} |\n\n`;

            // Categorized changes
            summary += `### ðŸ“ Changed Areas\n`;
            if (categories.src.length) summary += `- **Source**: ${categories.src.join(', ')}\n`;
            if (categories.tests.length) summary += `- **Tests**: ${categories.tests.join(', ')}\n`;
            if (categories.config.length) summary += `- **Config**: ${categories.config.join(', ')}\n`;
            if (categories.docs.length) summary += `- **Docs**: ${categories.docs.join(', ')}\n`;
            if (categories.ci.length) summary += `- **CI/CD**: ${categories.ci.join(', ')}\n`;
            summary += '\n';

            // Type check results
            const typeErrors = '${{ steps.typecheck.outputs.errors }}';
            if (typeErrors !== '0') {
              summary += `### âš ï¸ Type Check\n`;
              summary += `Found **${typeErrors}** TypeScript error(s). Please fix before merging.\n\n`;
            } else {
              summary += `### âœ… Type Check\nNo TypeScript errors found.\n\n`;
            }

            // Warnings
            const warnings = [];
            if (files.length > 20) warnings.push('Large PR â€” consider splitting into smaller changes');
            if (categories.src.length > 0 && categories.tests.length === 0) warnings.push('Source changes without tests â€” consider adding test coverage');
            if (stats.added > 500) warnings.push('Many lines added â€” ensure thorough review');

            const srcWithoutDashboard = categories.src.filter(f => !f.includes('route') && !f.includes('agent'));
            if (srcWithoutDashboard.some(f => f.includes('index.ts'))) warnings.push('Core server file modified â€” verify MCP tool compatibility');

            if (warnings.length) {
              summary += `### âš¡ Review Notes\n`;
              for (const w of warnings) summary += `- ${w}\n`;
            }

            // Post or update comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const botComment = comments.find(c => c.body.includes('ðŸ¤– Automated Code Review'));

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: summary
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: summary
              });
            }
